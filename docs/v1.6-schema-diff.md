# ðŸ“ v1.6 Schema Diff Draft

**Base Version:** v1.5.0  
**Target Version:** v1.6.0  
**Focus:** Validation Layer & Feedback Loop Staging

---

## ðŸ”„ Schema Additions

### **New Validation Schemas**

```typescript
// Pseudo-schema (no actual code)
TemplateValidationSchema {
  // Section 1: Prompt Basics
  goal: string.min(10).max(500) // "Goal must be 10-500 characters"
  keyOffer: string.min(5).max(200).optional()
  
  // Section 2: Target Audience
  audience: string.min(5).max(200)
  tone: enum(['casual', 'professional', 'academic', 'creative', 'technical', 'empathetic', 'authoritative', 'friendly'])
  
  // Section 3: Output Style
  industry: string.min(2).max(100).optional()
  experienceLevel: enum(['beginner', 'intermediate', 'advanced', 'expert']).optional()
  outputFormat: string.max(100).optional()
  
  // Section 4: AI Model Selection (v1.5 fields)
  aiModels: array(enum(AI_MODELS)).min(1).default(['claude-3-sonnet'])
  platformVersion: string
    .pattern(/^v?\d+(\.\d+)?(\.\d+)?$/) // "v2.0", "3.5", "v1.0.1"
    .max(10)
    .optional()
    .refine(val => !val || /^v?\d+(\.\d+)?(\.\d+)?$/.test(val), {
      message: "Version must be like 'v2.0' or '3.5'"
    })
  useCaseCategory: enum(['content-creation', 'analysis', 'coding', 'customer-service', 'education', 'research', 'creative-writing', 'data-processing', 'automation'])
    .optional()
    .describe("Please select a valid use case category")
  finalOutputFormat: enum(['text', 'markdown', 'json', 'xml', 'html', 'code', 'structured-data', 'csv', 'yaml'])
    .default('text')
    .optional()
    .describe("Please select a valid output format")
  audienceSensitivity: enum(['low', 'medium', 'high'])
    .default('medium')
    .optional()
    .describe("Setting sensitivity helps filter content appropriately")
  
  // Section 5: Advanced Settings
  citationNeeded: boolean.optional()
  rubricMode: enum(['strict', 'balanced', 'flexible']).optional()
  clarityLevel: enum(['simple', 'standard', 'technical']).optional()
}

AgentValidationSchema {
  // Section 1: Agent Identity
  title: string.min(5).max(200) // "Agent title must be 5-200 characters"
  agentName: string
    .min(2, "Agent name needs at least 2 characters")
    .max(50, "Agent name too long (max 50 characters)")
    .pattern(/^[a-zA-Z0-9\s\-\.]+$/, "Use letters, numbers, spaces, hyphens, or dots only")
    .optional()
  
  // Section 2: Personality & Context
  agentContext: string.min(20).max(1000) // "Context must be detailed (20+ chars)"
  personalityStyle: enum(['professional', 'friendly-approachable', 'analytical', 'creative-imaginative', 'mentor-teacher', 'direct-efficient', 'empathetic-supportive', 'humorous-casual'])
    .default('professional')
    .optional()
    .describe("Personality style enhances agent interactions")
  
  // Section 3: Capabilities
  capabilities: string.min(10).max(500).optional()
  constraints: string.min(10).max(500).optional()
}

BlueprintValidationSchema {
  // Section 1: Media Basics
  title: string.min(5).max(200)
  description: string.min(20).max(2000)
  mediaStyle: string.min(5).max(500)
  
  // Section 2: Generator Settings (v1.5 fields)
  mediaGenerator: string
    .min(2, "Generator name needs at least 2 characters")
    .max(100, "Generator name too long (max 100 characters)")
    .pattern(/^[a-zA-Z0-9\s\-\.\/]+$/, "Use letters, numbers, spaces, hyphens, dots, or slashes")
    .optional()
    .describe("Specify generator for optimized prompts")
  mediaAgent: string
    .min(2, "Agent role needs at least 2 characters")
    .max(100, "Agent role too long (max 100 characters)")
    .pattern(/^[a-zA-Z0-9\s\-\,\.]+$/, "Use letters, numbers, spaces, hyphens, commas, or dots")
    .optional()
  
  // Section 3: Output Specifications
  platform: enum(['midjourney', 'dall-e', 'stable-diffusion', 'runway', 'pika', 'eleven-labs', 'suno', 'udio', 'heygen', 'd-id']).default('midjourney')
  resolution: enum(['512x512', '1024x1024', '1920x1080', '3840x2160', '4096x4096']).default('1024x1024')
  aspectRatio: enum(['1:1', '16:9', '9:16', '4:3', '3:4', '21:9', 'custom']).default('16:9')
  fileType: enum(['jpg', 'png', 'webp', 'mp4', 'mov', 'wav', 'mp3']).default('jpg')
  exportUseCase: enum(['social-media', 'print', 'web', 'presentation', 'video-production']).default('social-media')
  packagingPreference: enum(['single-file', 'batch', 'layered', 'animated-sequence']).default('single-file')
  
  // Section 4: Advanced
  mood: string.max(500).optional()
  useCase: string.max(500).optional()
  
  // Platform-specific fields (dynamic based on platform)
  // These are conditionally added based on platform selection
}
```

### **Draft vs Publish Validation**

**Draft Mode:**
- All fields save regardless of validation
- Warnings shown but not blocking
- LocalStorage persists invalid data
- Toast: "Draft saved with X warnings"

**Publish/Generate Mode:**
- Validation errors block submission
- All required fields must be valid
- Pattern/enum violations prevent generation
- Toast: "Please fix X errors before publishing"

### **Cross-Field Validation Rules**

1. **Template Mode:**
   - If `tone` = 'academic', require `citationNeeded` = true
   - If `experienceLevel` = 'beginner', limit `technicalDepth` options
   - If `aiModels` includes 'claude-3', suggest `platformVersion` >= 'v3.0'
   - If `audienceSensitivity` = 'high', warn on missing content filters

2. **Agent Mode:**
   - If `personalityStyle` = 'professional', validate formal language in `agentContext`
   - If `constraints` provided, ensure not contradicting `capabilities`

3. **Blueprint Mode:**
   - If `platform` = 'midjourney', validate `resolution` matches allowed values
   - If `fileType` = video format, require `duration` field
   - If `aspectRatio` = '9:16', suggest mobile-optimized `exportUseCase`

---

## ðŸ”® Feedback Loop Schema Extensions

### **New Interfaces (Stub Only)**

```typescript
// Evaluation request interface
interface FeedbackRequest {
  promptId: string
  generatedPrompt: string
  formData: TemplateFormData | AgentFormData | BlueprintFormData
  mode: PromptMode
  timestamp: number
}

// Evaluation response interface
interface FeedbackResponse {
  qualityScore: number // 0-100
  coherenceRating: number // 1-5
  completenessRating: number // 1-5
  suggestions: string[]
  warnings: string[]
  improvements: {
    field: string
    suggestion: string
    impact: 'low' | 'medium' | 'high'
  }[]
}

// UI display interface
interface FeedbackDisplay {
  showFeedback: boolean
  feedbackData?: FeedbackResponse
  isLoading: boolean
  error?: string
}
```

### **Stub Payload Structure**

```typescript
// Mock evaluation endpoint payload
{
  method: 'POST',
  endpoint: '/api/evaluate', // Stubbed, no external call
  payload: {
    prompt: string,
    metadata: {
      mode: string,
      trustScore: number,
      fieldCount: number,
      characterCount: number
    }
  },
  response: {
    // Mocked response for v1.6
    qualityScore: 85,
    suggestions: ["Consider adding more context", "Tone could be more specific"]
  }
}
```

---

## ðŸ“Š Validation Error Messages

### **Field-Specific Messages (v1.5 Fields)**

| Field | Validation | Error Message |
|-------|------------|---------------|
| **Template Fields** | | |
| platformVersion | pattern | "Version must be like 'v2.0' or '3.5'" |
| platformVersion | max(10) | "Version number too long (max 10 characters)" |
| useCaseCategory | enum | "Please select a valid use case category" |
| finalOutputFormat | enum | "Please select a valid output format" |
| audienceSensitivity | recommended | "Setting sensitivity helps filter content appropriately" |
| **Agent Fields** | | |
| agentName | min(2) | "Agent name needs at least 2 characters" |
| agentName | max(50) | "Agent name too long (max 50 characters)" |
| agentName | pattern | "Use letters, numbers, spaces, hyphens, or dots only" |
| personalityStyle | recommended | "Personality style enhances agent interactions" |
| **Blueprint Fields** | | |
| mediaGenerator | min(2) | "Generator name needs at least 2 characters" |
| mediaGenerator | max(100) | "Generator name too long (max 100 characters)" |
| mediaGenerator | pattern | "Use letters, numbers, spaces, hyphens, dots, or slashes" |
| mediaGenerator | recommended | "Specify generator for optimized prompts" |
| mediaAgent | min(2) | "Agent role needs at least 2 characters" |
| mediaAgent | max(100) | "Agent role too long (max 100 characters)" |
| mediaAgent | pattern | "Use letters, numbers, spaces, hyphens, commas, or dots" |

### **Smart Validation Helpers**

1. **Auto-suggestions:**
   - If user types "kid" in audience â†’ Suggest "children aged 5-12"
   - If tone is "casual" + audience is "executives" â†’ Warning about mismatch

2. **Progressive disclosure:**
   - Show validation only after field blur
   - Inline success checkmarks for valid fields
   - Red outline + message for invalid fields

3. **Batch validation:**
   - Validate all fields on submit
   - Show summary of issues at top
   - Auto-scroll to first error

---

## ðŸŽ¨ Validation UI Patterns

### **Visual Feedback States**

```
Field States:
- Default: Gray border, no icon
- Focus: Blue border, no validation
- Valid: Green border, âœ“ icon
- Invalid: Red border, âœ— icon, error text
- Warning: Orange border, âš  icon, suggestion text
```

### **Error Display Hierarchy**

1. **Inline errors** - Below each field
2. **Section errors** - Card header badge with count
3. **Form errors** - Toast notification on submit
4. **Summary panel** - Collapsible list of all issues

---

## ðŸ”’ Security Validations

### **Input Sanitization**
- Strip HTML/script tags from all text inputs
- Limit special characters in certain fields
- Validate URL formats for links
- Check for SQL injection patterns

### **Rate Limiting Prep**
- Add request throttling interface
- Track generation attempts per session
- Implement cooldown periods for rapid submissions

---

## âœ… Migration Checklist

### **Phase 1: Schema Setup**
- [ ] Create validation.ts with Zod schemas
- [ ] Add error message constants
- [ ] Setup validation utilities

### **Phase 2: Component Integration**
- [ ] Add validation to TemplateForm
- [ ] Add validation to AgentForm
- [ ] Add validation to BlueprintForm
- [ ] Create shared validation components

### **Phase 3: Feedback Staging**
- [ ] Add feedback interfaces to schema
- [ ] Create stub API endpoint
- [ ] Add UI placeholders
- [ ] Mock response generation

### **Phase 4: Testing**
- [ ] Unit tests for validators
- [ ] Integration tests for forms
- [ ] E2E tests for submission flow
- [ ] Performance impact assessment

---

**Status:** DRAFT - Ready for implementation in v1.6 development cycle
---

## Field Deprecation Updates

### outputContentType
- **Status:** DEPRECATED
- **Location:** TrustSafetySettings interface
- **Alias:** finalOutputFormat
- **Migration:** Automatic aliasing on load
- **UI:** Hidden from interface
- **Annotations:**
  - @deprecated Use finalOutputFormat instead
  - @readOnly true
  - @aliasOf finalOutputFormat

### finalOutputFormat
- **Status:** ACTIVE
- **Location:** Template form data
- **Type:** string (enum)
- **Required:** Yes (when visible)
- **Values:** ["structured", "narrative", "list", "json", "markdown", "table", "code", "dialogue"]
